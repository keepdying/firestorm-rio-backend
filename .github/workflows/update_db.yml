# This is a basic workflow to help you get started with Actions

name: Update DB

# Controls when the workflow will run
on:
  workflow_dispatch:
  
  push:
    branches: [ master ]
    
  schedule:
  - cron: '0 */4 * * *'
  

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2
      - name: Setup Python
        uses: actions/setup-python@v2.2.2
        with:
             python-version: 3.9
             
      #- name: Install git
      # uses: srt32/git-actions@v0.0.3
             
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pipenv
          pipenv install selenium dill bs4
          
      - name: Setup Chromedriver
        uses: nanasess/setup-chromedriver@v1.0.5
        
      - name: Start XVFB
        run: |
            sudo Xvfb -ac :99 -screen 0 1280x1024x24 > /dev/null 2>&1 &
        
      - name: Run fetch_runs.py
        run: pipenv run python fetch_runs.py 
        env:
          DISPLAY: :99
          
      - name: Run update_players.py
        run: pipenv run python update_players.py 
               
      - name: Add & Commit
        uses: EndBug/add-and-commit@v7.3.0
        with:
          add: '["runs.pickle", "players.pickle"]'
          author_name: Github Actions
          author_email: yunusemre34tr@gmail.com
          branch: master
          message: 'Updated DB (Github Actions)'
          push: true
          
          
      - name: Push to firestorm-rio
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |

          git clone https://keepdying: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@github.com/keepdying/firestorm-rio
          cp runs.json firestorm-rio/src/ 
          cp players.json firestorm-rio/src/
          cp lastUpdated.json firestorm-rio/src/
          cd firestorm-rio
          git config --global user.name "Github Actions"
          git config --global user.email "yunusemre34tr@gmail.com"
          git add src/runs.json
          git add src/players.json
          git add src/lastUpdated.json
          git commit -m "Updated DB"
          git push

